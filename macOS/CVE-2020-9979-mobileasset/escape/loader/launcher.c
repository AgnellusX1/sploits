#include <assert.h>
#include <dlfcn.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <sys/types.h>


void *map(const char *filename, size_t *osize) {
  struct stat st;
  stat(filename, &st);
  size_t size = st.st_size;
  int fd = open(filename, O_RDONLY, 0);
  assert(fd != -1);
  void *data = mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_PRIVATE, fd, 0);
  assert(data != MAP_FAILED);
  *osize = size;
  return data;
}

int main(int argc, char *argv[]) {
  // preload Objective C Runtime
  dlopen("/System/Library/Frameworks/Foundation.framework/Foundation", RTLD_NOW);
  void *jsc = dlopen("/System/Library/Frameworks/JavaScriptCore.framework/JavaScriptCore", RTLD_NOW);
  void *leak = dlsym(jsc, "JSClassCreate");

  size_t shellcode_len = 0, dylib_len = 0;
  void *shellcode = map(argv[1], &shellcode_len);
  void *dylib = map(argv[2], &dylib_len);

  printf("dylib: %p, len: %zu\n", dylib, dylib_len);

  // fill arguments
  unsigned long long magic[] = {0xCCCCDDDDEEEEFFFF, 0xDEADBEEFDEADBEEF, 0xAAAABBBBCCCCDDDD};
  void *p = memmem(shellcode, shellcode_len, magic, sizeof(unsigned long long));
  // printf("p: %p\n", p);
  *(unsigned long long*)memmem(shellcode, shellcode_len, magic, sizeof(unsigned long long)) = (unsigned long long)leak;
  *(unsigned long long*)memmem(shellcode, shellcode_len, magic + 1, sizeof(unsigned long long)) = (unsigned long long)dylib;
  *(unsigned long long*)memmem(shellcode, shellcode_len, magic + 2, sizeof(unsigned long long)) = (unsigned long long)dylib_len;

  // printf("mem read %p\n", shellcode);

#define RWX_SIZE 1024 * 1024 * 1024
#define DATA_SIZE 1024 * 1024 * 4

  void *startOfFixedExecutableMemoryPool =
      mmap(NULL, RWX_SIZE, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);
  assert(startOfFixedExecutableMemoryPool != MAP_FAILED);
  printf("mapped RWX: %p, size: %d\n", startOfFixedExecutableMemoryPool, RWX_SIZE);

  memcpy(startOfFixedExecutableMemoryPool, shellcode, shellcode_len);

  uintptr_t *end = dlsym(jsc, "_ZN3JSC36taggedEndOfFixedExecutableMemoryPoolE");

  printf("end: %p\n", end);
  *end = (uintptr_t)startOfFixedExecutableMemoryPool + RWX_SIZE;

  typedef void *(*go_t)(void);

  go_t go = (go_t)startOfFixedExecutableMemoryPool;
  go();

  munmap(shellcode, shellcode_len);
  munmap(dylib, dylib_len);

  return 0;
}